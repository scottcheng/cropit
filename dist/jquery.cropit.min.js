!function(i){var t;t=function(){function i(){}return i.prototype.setup=function(i,t,e,o){var s,n;return null==e&&(e=1),n=t.w/i.w,s=t.h/i.h,this.minZoom=(null!=o?o.fitWidth:void 0)&&!(null!=o?o.fitHeight:void 0)?n:(null!=o?o.fitHeight:void 0)&&!(null!=o?o.fitWidth:void 0)?s:(null!=o?o.fitWidth:void 0)&&(null!=o?o.fitHeight:void 0)?s>n?n:s:s>n?s:n,this.maxZoom=this.minZoom<1/e?1/e:this.minZoom},i.prototype.getZoom=function(i){return this.minZoom&&this.maxZoom?i*(this.maxZoom-this.minZoom)+this.minZoom:null},i.prototype.getSliderPos=function(i){return this.minZoom&&this.maxZoom?this.minZoom===this.maxZoom?0:(i-this.minZoom)/(this.maxZoom-this.minZoom):null},i.prototype.isZoomable=function(){return this.minZoom&&this.maxZoom?this.minZoom!==this.maxZoom:null},i.prototype.fixZoom=function(i){return i<this.minZoom?this.minZoom:i>this.maxZoom?this.maxZoom:i},i}();var e;e=function(){function e(t,o){var s;this.element=t,this.$el=i(this.element),s={$fileInput:this.$("input.cropit-image-input"),$preview:this.$(".cropit-image-preview"),$zoomSlider:this.$("input.cropit-image-zoom-input"),$previewContainer:this.$(".cropit-image-preview-container")},this.options=i.extend({},e._DEFAULTS,s,o),this.init()}return e._DEFAULTS={exportZoom:1,imageBackground:!1,imageBackgroundBorderWidth:0,imageState:null,allowCrossOrigin:!1},e.PREVIEW_EVENTS=function(){return["mousedown","mouseup","mouseleave","touchstart","touchend","touchcancel","touchleave"].map(function(i){return""+i+".cropit"}).join(" ")}(),e.PREVIEW_MOVE_EVENTS="mousemove.cropit touchmove.cropit",e.ZOOM_INPUT_EVENTS=function(){return["mousemove","touchmove","change"].map(function(i){return""+i+".cropit"}).join(" ")}(),e.prototype.init=function(){var e,o,s,n,r;return this.image=new Image,this.options.allowCrossOrigin&&(this.image.crossOrigin="Anonymous"),this.$fileInput=this.options.$fileInput.attr({accept:"image/*"}),this.$preview=this.options.$preview.css({backgroundRepeat:"no-repeat"}),this.$zoomSlider=this.options.$zoomSlider.attr({min:0,max:1,step:.01}),this.previewSize={w:this.options.width||this.$preview.width(),h:this.options.height||this.$preview.height()},this.options.width&&this.$preview.width(this.previewSize.w),this.options.height&&this.$preview.height(this.previewSize.h),this.options.imageBackground&&(o=this.options.imageBackgroundBorderWidth,e=this.options.$previewContainer,this.$imageBg=i("<img />").addClass("cropit-image-background").attr("alt","").css("position","absolute"),this.$imageBgContainer=i("<div />").addClass("cropit-image-background-container").css({position:"absolute",zIndex:0,left:-o+window.parseInt(this.$preview.css("border-left-width")),top:-o+window.parseInt(this.$preview.css("border-top-width")),width:this.previewSize.w+2*o,height:this.previewSize.h+2*o}).append(this.$imageBg),o>0&&this.$imageBgContainer.css({overflow:"hidden"}),e.css("position","relative").prepend(this.$imageBgContainer),this.$preview.css("position","relative"),this.$preview.hover(function(i){return function(){return i.$imageBg.addClass("cropit-preview-hovered")}}(this),function(i){return function(){return i.$imageBg.removeClass("cropit-preview-hovered")}}(this))),this.initialOffset={x:0,y:0},this.initialZoom=0,this.initialZoomSliderPos=0,this.imageLoaded=!1,this.moveContinue=!1,this.zoomer=new t,this.bindListeners(),this.$zoomSlider.val(this.initialZoomSliderPos),this.setOffset((null!=(s=this.options.imageState)?s.offset:void 0)||this.initialOffset),this.zoom=(null!=(n=this.options.imageState)?n.zoom:void 0)||this.initialZoom,this.loadImage((null!=(r=this.options.imageState)?r.src:void 0)||null)},e.prototype.bindListeners=function(){return this.$fileInput.on("change.cropit",this.onFileChange.bind(this)),this.$preview.on(e.PREVIEW_EVENTS,this.onPreviewEvent.bind(this)),this.$zoomSlider.on(e.ZOOM_INPUT_EVENTS,this.onZoomSliderChange.bind(this))},e.prototype.unbindListeners=function(){return this.$fileInput.off("change.cropit"),this.$preview.off(e.PREVIEW_EVENTS),this.$zoomSlider.off(e.ZOOM_INPUT_EVENTS)},e.prototype.reset=function(){return this.zoom=this.initialZoom,this.offset=this.initialOffset},e.prototype.onFileChange=function(){var i,t,e;return"function"==typeof(e=this.options).onFileChange&&e.onFileChange(),t=new FileReader,i=this.$fileInput.get(0).files[0],(null!=i?i.type.match("image"):void 0)?(this.setImageLoadingClass(),t.readAsDataURL(i),t.onload=this.onFileReaderLoaded.bind(this),t.onerror=this.onFileReaderError.bind(this)):void 0},e.prototype.onFileReaderLoaded=function(i){return this.reset(),this.loadImage(i.target.result)},e.prototype.onFileReaderError=function(){var i;return"function"==typeof(i=this.options).onFileReaderError?i.onFileReaderError():void 0},e.prototype.loadImage=function(i){var t;return this.imageSrc=i,this.imageSrc?("function"==typeof(t=this.options).onImageLoading&&t.onImageLoading(),this.setImageLoadingClass(),this.image.onload=this.onImageLoaded.bind(this),this.image.onerror=this.onImageError.bind(this),this.image.src=this.imageSrc):void 0},e.prototype.onImageLoaded=function(){var i;return this.setImageLoadedClass(),this.setOffset(this.offset),this.$preview.css("background-image","url("+this.imageSrc+")"),this.options.imageBackground&&this.$imageBg.attr("src",this.imageSrc),this.imageSize={w:this.image.width,h:this.image.height},this.setupZoomer(),this.imageLoaded=!0,"function"==typeof(i=this.options).onImageLoaded?i.onImageLoaded():void 0},e.prototype.onImageError=function(){var i;return"function"==typeof(i=this.options).onImageError?i.onImageError():void 0},e.prototype.setImageLoadingClass=function(){return this.$preview.removeClass("cropit-image-loaded").addClass("cropit-image-loading")},e.prototype.setImageLoadedClass=function(){return this.$preview.removeClass("cropit-image-loading").addClass("cropit-image-loaded")},e.prototype.getEventPosition=function(i){var t,e,o,s;return(null!=(t=i.originalEvent)&&null!=(e=t.touches)?e[0]:void 0)&&(i=null!=(o=i.originalEvent)&&null!=(s=o.touches)?s[0]:void 0),i.clientX&&i.clientY?{x:i.clientX,y:i.clientY}:void 0},e.prototype.onPreviewEvent=function(t){return this.imageLoaded?(this.moveContinue=!1,this.$preview.off(e.PREVIEW_MOVE_EVENTS),"mousedown"===t.type||"touchstart"===t.type?(this.origin=this.getEventPosition(t),this.moveContinue=!0,this.$preview.on(e.PREVIEW_MOVE_EVENTS,this.onMove.bind(this))):i(document.body).focus(),t.stopPropagation(),!1):void 0},e.prototype.onMove=function(i){var t;return t=this.getEventPosition(i),this.moveContinue&&t&&this.setOffset({x:this.offset.x+t.x-this.origin.x,y:this.offset.y+t.y-this.origin.y}),this.origin=t,i.stopPropagation(),!1},e.prototype.setOffset=function(i){return this.offset=this.fixOffset(i),this.$preview.css("background-position",""+this.offset.x+"px "+this.offset.y+"px"),this.options.imageBackground?this.$imageBg.css({left:this.offset.x+this.options.imageBackgroundBorderWidth,top:this.offset.y+this.options.imageBackgroundBorderWidth}):void 0},e.prototype.fixOffset=function(i){var t;return this.imageLoaded?(t={x:i.x,y:i.y},this.imageSize.w*this.zoom<=this.previewSize.w?t.x=0:t.x>0?t.x=0:t.x+this.imageSize.w*this.zoom<this.previewSize.w&&(t.x=this.previewSize.w-this.imageSize.w*this.zoom),this.imageSize.h*this.zoom<=this.previewSize.h?t.y=0:t.y>0?t.y=0:t.y+this.imageSize.h*this.zoom<this.previewSize.h&&(t.y=this.previewSize.h-this.imageSize.h*this.zoom),t.x=this.round(t.x),t.y=this.round(t.y),t):i},e.prototype.onZoomSliderChange=function(){var i;if(this.imageLoaded)return this.zoomSliderPos=Number(this.$zoomSlider.val()),i=this.zoomer.getZoom(this.zoomSliderPos),this.setZoom(i)},e.prototype.enableZoomSlider=function(){var i;return this.$zoomSlider.removeAttr("disabled"),"function"==typeof(i=this.options).onZoomEnabled?i.onZoomEnabled():void 0},e.prototype.disableZoomSlider=function(){var i;return this.$zoomSlider.attr("disabled",!0),"function"==typeof(i=this.options).onZoomDisabled?i.onZoomDisabled():void 0},e.prototype.setupZoomer=function(){return this.zoomer.setup(this.imageSize,this.previewSize,this.options.exportZoom,this.options),this.zoom=this.fixZoom(this.zoom),this.setZoom(this.zoom),this.isZoomable()?this.enableZoomSlider():this.disableZoomSlider()},e.prototype.setZoom=function(i){var t,e,o,s,n;return i=this.fixZoom(i),n=this.round(this.imageSize.w*i),s=this.round(this.imageSize.h*i),o=this.zoom,t=this.previewSize.w/2-(this.previewSize.w/2-this.offset.x)*i/o,e=this.previewSize.h/2-(this.previewSize.h/2-this.offset.y)*i/o,this.zoom=i,this.setOffset({x:t,y:e}),this.zoomSliderPos=this.zoomer.getSliderPos(this.zoom),this.$zoomSlider.val(this.zoomSliderPos),this.$preview.css("background-size",""+n+"px "+s+"px"),this.options.imageBackground?this.$imageBg.css({width:n,height:s}):void 0},e.prototype.fixZoom=function(i){return this.zoomer.fixZoom(i)},e.prototype.isZoomable=function(){return this.zoomer.isZoomable()},e.prototype.getCroppedImageData=function(t){var e,o,s,n,r;return this.imageSrc?(n={type:"image/png",quality:.75,originalSize:!1,fillBg:"#fff"},t=i.extend({},n,t),s={w:this.previewSize.w,h:this.previewSize.h},this.options.fitHeight&&!this.options.fitWidth&&this.imageSize.w*this.zoom<this.previewSize.w?s.w=this.imageSize.w*this.zoom:this.options.fitWidth&&!this.options.fitHeight&&this.imageSize.h*this.zoom<this.previewSize.h&&(s.h=this.imageSize.h*this.zoom),r=t.originalSize?1/this.zoom:this.options.exportZoom,e=i("<canvas />").attr({width:s.w*r,height:s.h*r}).get(0),o=e.getContext("2d"),("image/jpeg"==t.type||"image/jpg"==t.type)&&(o.fillStyle=t.fillBg,o.fillRect(0,0,e.width,e.height)),o.drawImage(this.image,this.offset.x*r,this.offset.y*r,this.zoom*r*this.imageSize.w,this.zoom*r*this.imageSize.h),e.toDataURL(t.type,t.quality)):null},e.prototype.getImageState=function(){return{src:this.imageSrc,offset:this.offset,zoom:this.zoom}},e.prototype.getImageSrc=function(){return this.imageSrc},e.prototype.getOffset=function(){return this.offset},e.prototype.getZoom=function(){return this.zoom},e.prototype.getImageSize=function(){return this.imageSize?{width:this.imageSize.w,height:this.imageSize.h}:null},e.prototype.getPreviewSize=function(){return{width:this.previewSize.w,height:this.previewSize.h}},e.prototype.setPreviewSize=function(i){return(null!=i?i.width:void 0)>0&&(null!=i?i.height:void 0)>0?(this.previewSize={w:i.width,h:i.height},this.$preview.css({width:this.previewSize.w,height:this.previewSize.h}),this.options.imageBackground&&this.$imageBgContainer.css({width:this.previewSize.w+2*this.options.imageBackgroundBorderWidth,height:this.previewSize.h+2*this.options.imageBackgroundBorderWidth}),this.imageLoaded?this.setupZoomer():void 0):void 0},e.prototype.disable=function(){return this.unbindListeners(),this.disableZoomSlider(),this.$el.addClass("cropit-disabled")},e.prototype.reenable=function(){return this.bindListeners(),this.enableZoomSlider(),this.$el.removeClass("cropit-disabled")},e.prototype.round=function(i){return Math.round(1e5*i)/1e5},e.prototype.$=function(i){return this.$el?this.$el.find(i):null},e}();var o,s;o="cropit",s={init:function(t){return this.each(function(){var s;return i.data(this,o)?void 0:(s=new e(this,t),i.data(this,o,s))})},destroy:function(){return this.each(function(){return i.removeData(this,o)})},isZoomable:function(){var i;return i=this.first().data(o),null!=i?i.isZoomable():void 0},"export":function(i){var t;return t=this.first().data(o),null!=t?t.getCroppedImageData(i):void 0},imageState:function(){var i;return i=this.first().data(o),null!=i?i.getImageState():void 0},imageSrc:function(t){var e;return null!=t?this.each(function(){var e;return e=i.data(this,o),null!=e&&e.reset(),null!=e?e.loadImage(t):void 0}):(e=this.first().data(o),null!=e?e.getImageSrc():void 0)},offset:function(t){var e;return null!=t&&null!=t.x&&null!=t.y?this.each(function(){var e;return e=i.data(this,o),null!=e?e.setOffset(t):void 0}):(e=this.first().data(o),null!=e?e.getOffset():void 0)},zoom:function(t){var e;return null!=t?this.each(function(){var e;return e=i.data(this,o),null!=e?e.setZoom(t):void 0}):(e=this.first().data(o),null!=e?e.getZoom():void 0)},imageSize:function(){var i;return i=this.first().data(o),null!=i?i.getImageSize():void 0},previewSize:function(t){var e;return null!=t?this.each(function(){var e;return e=i.data(this,o),null!=e?e.setPreviewSize(t):void 0}):(e=this.first().data(o),null!=e?e.getPreviewSize():void 0)},disable:function(){return this.each(function(){var t;return t=i.data(this,o),t.disable()})},reenable:function(){return this.each(function(){var t;return t=i.data(this,o),t.reenable()})}},i.fn.cropit=function(i){return s[i]?s[i].apply(this,[].slice.call(arguments,1)):s.init.apply(this,arguments)}}(window.jQuery);